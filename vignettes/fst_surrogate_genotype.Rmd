---
title: "Fst computation after removing  adaptive genetic variation associated with environmental variables"
author: "Clement Gain"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fst computation after removing  adaptive genetic variation associated with environmental variables}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=7, fig.height=7
)
```

The aim of this vignette is to show the usefulness of spectral theory in order to compute Fst of surrogate genotype. In this example, we're going to use genotype data coming from Arabidopsis Thaliana and the goal is to obtain the Fst after removing adaptive genetic variation associated with environmental variables (Bioclim 1 to 18 coming from WorldClim database). This can be done using the *make_adjustment* and *adjusting_variables* parameters from the **compute_partition** function.

```{r}
library(spectralfst)
```

## Loading Data

All these datas are contained in the *spectralfst* package.


```{r}
data('pop_label')
data('athaliana_n241_L10k')
data('climate')

genotype_athaliana <- as.matrix(athaliana_n241_L10k)
env_var <- as.matrix(climate)
pop_athaliana <- pop_label[,1]
```


## Computing Fst on the genotype matrix without adjustment

First, we're not realizing any adjustment.

```{r}
spectral_athaliana <- compute_partition(genotype_athaliana, pop_athaliana)
wright_fst_athaliana <- mean_wright_fst(genotype_athaliana, pop_athaliana)

print("mean Fst compute with Wright's formula :")
wright_fst_athaliana
print("Fst compute with between population matrix Zst")
spectral_athaliana$Fst
print("Fst approximation using Z matrix")
spectral_athaliana$Fst_approximation
```

## Adjusting for adaptive genetic variation associated with environmental variables 

We're now going to use the make_adjustment and adjusting_variables parameters. The adjusting_variables will be composed of the 18 Bioclim variables. It must be a n (= number of individuals) x D (= number of environmental variables) matrix. In our specific case, the matrix has 241 rows and 18 columns

```{r}
spectral_adjusted_athaliana <- compute_partition(genotype_athaliana, pop_athaliana, make_adjustment = T, adjusting_variables = env_var)

print("Fst compute with between population matrix Zst")
spectral_adjusted_athaliana$Fst
print("Fst approximation using Z matrix")
spectral_adjusted_athaliana$Fst_approximation
```

We can see that removing adaptive genetic variation has logically led to a decrease of Fst value

## Figures

```{r}
m <- cbind(spectral_athaliana$eigenZ[1:6],spectral_adjusted_athaliana$eigenZ[1:6])
plot(seq(1,12)/2,as.numeric(t(m)), 
     col = rep(c("darkblue","orange"), length = 12), 
     type = "h", lwd = 10, 
     ylab = "Proportion of variance",
     xlab = "PC axis",
    # main = "PCA",
     cex.axis = .9,
     las = 1)

legend(x = 3.5, y = 0.081, 
       legend = c("All SNPs", "Adjusted data"),
       col = c("darkblue","orange"),
       lty = c(1,1),
       pch = 19,
       cex = 1)
```

```{r}
m <- cbind(c(spectral_athaliana$eigenZst[1], spectral_athaliana$eigenZs[1:5]),
           c(spectral_adjusted_athaliana$eigenZst[1], spectral_adjusted_athaliana$eigenZs[1:5]))
plot(seq(1,12)/2,as.numeric(t(m)), 
     col = rep(c("lightblue","orange"), length = 12), 
     type = "h", lwd = 10, 
     ylab = "Proportion of variance",
     xlab = "PC axis",
    # main = "Structure Components",
     cex.axis = .9,
     las = 1)

legend(x = 3.5, y = 0.077, 
       legend = c("All SNPs", "Adjusted data"),
       col = c("lightblue","orange"),
       lty = c(1,1),
       pch = 19,
       cex = 1)
```



